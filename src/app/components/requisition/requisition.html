<div class="container-fluid">

<div class="requisition-page">
  <!-- Content Menu Component -->
  <app-content-menu 
    [activeSection]="activeSection"
    (sectionChange)="onSectionChange($event)">
  </app-content-menu>

  <!-- Main Content -->
    <div class="requisition-container">
      <div class="row g-4">
    <!-- Panel izquierdo - Selección de productos -->
    <div [class]="isResumeCollapsed ? 'col-11' : 'col-lg-7'" class="transition-all">
      <div class="card shadow h-100">
        <div class="card-header bg-primary text-white">
          <h4>Agregar</h4>
        </div>
        
        <div class="card-body">
          <!-- 1. Configuración de fecha de entrega (OBLIGATORIO) -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card ">
                <div class="card-body p-3">
                  <div class="row align-i tems-center g-3">
                    <div class="col-12">
                      <h6 class="fw-bold text-warning-emphasis mb-3">
                        <i class="bi bi-calendar-event me-2"></i>Fecha de entrega (Obligatorio)
                      </h6>
                    </div>
                    
                    <div class="col-12 col-md-4">
                      <label class="form-label mb-1 fw-bold">Evento especial:</label>
                      <select 
                        class="form-select" 
                        [(ngModel)]="selectedEvent"
                        (change)="onEventChange()">
                        <option value="">Seleccionar evento</option>
                        <option 
                          *ngFor="let event of events" 
                          [value]="event.id"
                          [disabled]="isEventDatePassed(event.date)">
                          {{ event.name }} ({{ formatDate(event.date) }})
                        </option>
                      </select>
                      <small class="text-muted">*Entrega 1 día antes del evento</small>
                    </div>
                    
                    <div class="col-12 col-md-4">
                      <label class="form-label mb-1 fw-bold">Fecha personalizada:</label>
                      <input 
                        type="date" 
                        class="form-control"
                        [(ngModel)]="customDeliveryDate"
                        (change)="onCustomDateChange()"
                        [min]="getMinDate()">
                      <small class="text-muted">*Entrega en la fecha exacta</small>
                    </div>
                    
                    <div class="col-12 col-md-4" *ngIf="currentDeliveryDate">
                      <div class="alert alert-success mb-0 py-2">
                        <small>
                          <i class="bi bi-check-circle me-1"></i>
                          <strong>Entrega:</strong> {{ formatDate(currentDeliveryDate) }}
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 2. Selección de área (SEGUNDO) -->
          <div class="row align-items-center mb-4">
            <div class="col-12 col-lg-auto">
              <label class="form-label fw-bold mb-2">Área:</label>
            </div>
            <div class="col-12 col-lg-5 position-relative">
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="areaSearchTerm"
                (input)="onAreaSearch()"
                (focus)="onAreaFocus()"
                (blur)="onAreaBlur()"
                placeholder="Buscar área..."
                autocomplete="off">
              
              <!-- Dropdown de áreas -->
              <div 
                class="dropdown-menu show w-100" 
                *ngIf="showAreaDropdown && filteredAreas.length > 0"
                style="position: absolute; top: 100%; z-index: 1000; max-height: 200px; overflow-y: auto;">
                <button 
                  type="button"
                  class="dropdown-item d-flex justify-content-between"
                  *ngFor="let area of filteredAreas"
                  (mousedown)="selectArea(area)">
                  <span>{{ area }}</span>
                  <span *ngIf="hasProductsInArea(area)" class="text-success">✓</span>
                </button>
              </div>
              
              <!-- Mensaje cuando no hay resultados -->
              <div 
                class="dropdown-menu show w-100" 
                *ngIf="showAreaDropdown && filteredAreas.length === 0 && areaSearchTerm.length > 0"
                style="position: absolute; top: 100%; z-index: 1000;">
                <div class="dropdown-item-text text-muted">
                  No se encontraron áreas
                </div>
              </div>
            </div>
          </div>

          <!-- 3. Búsqueda de productos (TERCERO) -->
          <div class="row mb-4">
            <div class="col-md-5 position-relative">
              <label class="form-label ">Producto</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="productSearchTerm"
                (input)="onProductSearch()"
                (focus)="onProductFocus()"
                (blur)="onProductBlur()"
                placeholder="Buscar producto..."
                autocomplete="off"
                [disabled]="!currentDeliveryDate || !selectedArea">
              
              <!-- Dropdown de productos -->
              <div 
                class="dropdown-menu show w-100" 
                *ngIf="showProductDropdown && filteredProducts.length > 0 && !(!currentDeliveryDate || !selectedArea)"
                style="position: absolute; top: 100%; z-index: 1000; max-height: 200px; overflow-y: auto;">
                <button 
                  type="button"
                  class="dropdown-item"
                  *ngFor="let product of filteredProducts"
                  (mousedown)="selectProduct(product)">
                  {{ product }}
                </button>
              </div>
              
              <!-- Mensaje cuando no hay resultados -->
              <div 
                class="dropdown-menu show w-100" 
                *ngIf="showProductDropdown && filteredProducts.length === 0 && productSearchTerm.length > 0 && !(!currentDeliveryDate || !selectedArea)"
                style="position: absolute; top: 100%; z-index: 1000;">
                <div class="dropdown-item-text text-muted">
                  No se encontraron productos
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label ">Cantidad</label>
              <input 
                type="text" 
                class="form-control " 
                [(ngModel)]="currentQuantity"
                (input)="validateNumberInput($event)"
                placeholder="Ingrese cantidad"
                [disabled]="!currentDeliveryDate || !selectedArea">
            </div>
            <div class="col-md-3">
              <label class="form-label ">Presentación</label>
              <select class="form-select" [(ngModel)]="selectedUnit" [disabled]="!currentDeliveryDate || !selectedArea">
                <option *ngFor="let unit of units" [value]="unit">{{ unit }}</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-primary  w-100" (click)="onAddProduct()" [disabled]="!currentDeliveryDate || !selectedArea">
                Agregar
              </button>
            </div>
          </div>
          
          <!-- Lista de productos seleccionados -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-primary">
                <tr>
                  <th class="py-3">Producto</th>
                  <th class="py-3">Cantidad</th>
                  <th class="py-3">Presentación</th>
                  <th class="py-3">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of products; trackBy: trackByProductId">
                  <td class="fs-6 py-3">{{ product.name }}</td>
                  <td>
                    <div class="input-group" style="width: 150px;">
                      <button 
                        class="btn btn-outline-secondary" 
                        type="button" 
                        (click)="decrementQuantity(product.id)"
                        [disabled]="product.quantity <= 1">
                        <i class="bi bi-dash"></i>
                      </button>
                      <input 
                        type="text" 
                        class="form-control text-center" 
                        [value]="product.quantity"
                        (input)="updateQuantityFromInput(product.id, $event)"
                        (blur)="validateTableInput(product.id, $event)">
                      <button 
                        class="btn btn-outline-secondary" 
                        type="button" 
                        (click)="incrementQuantity(product.id)">
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </td>
                  <td class="fs-6 py-3">{{ product.unit }}</td>
                  <td>
                    <button 
                      class="btn btn-danger "
                      (click)="removeProduct(product.id)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="text-end mt-4">
            <button class="btn btn-primary  px-5" (click)="onAccept()">
              Aceptar
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Panel derecho - Resumen de solicitud -->
    <div [class]="isResumeCollapsed ? 'col-1' : 'col-lg-5'" class="transition-all">
      <div class="card shadow h-100">
        <div class="card-header bg-success text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1" [class.d-none]="isResumeCollapsed">
              <h4 class="text-white mb-1">Resumen de solicitud</h4>
              <div *ngIf="getRequestDeliveryDate()" class="small">
                <i class="bi bi-calendar-check me-1"></i>
                <strong>Fecha de entrega:</strong> {{ formatDate(getRequestDeliveryDate()!) }}
              </div>
              <div *ngIf="!getRequestDeliveryDate()" class="small text-white-50">
                <i class="bi bi-calendar-x me-1"></i>
                Sin fecha programada
              </div>
            </div>
            <!-- Spacer invisible para mantener el botón a la derecha cuando está colapsado -->
            <div class="flex-grow-1" [class.d-none]="!isResumeCollapsed"></div>
            <button 
              class="btn btn-success btn-sm border-white" 
              (click)="toggleResumePanel()"
              [title]="isResumeCollapsed ? 'Mostrar resumen' : 'Ocultar resumen'">
              <i [class]="isResumeCollapsed ? 'bi bi-chevron-left' : 'bi bi-chevron-right'"></i>
            </button>
          </div>
        </div>
        
        <div class="card-body p-4" [class.d-none]="isResumeCollapsed">
          <div *ngIf="requisitionSummary.length === 0" class="text-center text-muted py-5">
            <i class="bi bi-clipboard-x fs-1 d-block mb-3"></i>
            <p class="fs-5">No hay áreas con productos agregados</p>
            <small>Selecciona un área, agrega productos y presiona "Aceptar"</small>
          </div>
          
          <div *ngFor="let summary of requisitionSummary" class="mb-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div class="flex-grow-1">
                <h5 class="text-primary fw-bold mb-1">{{ summary.area }}</h5>
              </div>
              <button 
                class="btn btn-outline-danger btn-sm"
                (click)="removeAreaFromSummary(summary.area)"
                title="Eliminar área">
                <i class="bi bi-trash"></i>
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-borderless">
                <thead class="table-secondary">
                  <tr>
                    <th class="fs-6 py-3">Producto</th>
                    <th class="fs-6 py-3">Cantidad</th>
                    <th class="fs-6 py-3">Presentación</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let product of summary.products">
                    <td class="fs-6 py-2">{{ product.name }}</td>
                    <td class="fs-6 py-2">{{ product.quantity }}</td>
                    <td class="fs-6 py-2">{{ product.unit }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="text-end mt-4" *ngIf="requisitionSummary.length > 0">
            <button class="btn btn-success  px-5" (click)="onConfirmRequisition()">
              Confirmar solicitud
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  </div>
</div>