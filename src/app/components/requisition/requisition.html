<div class="container-fluid">
  <div class="bg-light" style="min-height: 100vh; max-height: 100vh; overflow: hidden;">
    <!-- Content Menu Component -->
    <app-content-menu 
      [activeSection]="activeSection"
      (sectionChange)="onSectionChange($event)">
    </app-content-menu>

    <!-- Main Content -->
    <div class="p-4" style="height: calc(100vh - 120px); overflow: hidden;">
      <div class="row g-4 h-100">
        <!-- Panel izquierdo - Selección de productos -->
        <div [class]="isResumeCollapsed ? 'col-11' : 'col-lg-7'" class="transition-all">
          <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
              <h4>Agregar</h4>
            </div>
            
            <div class="card-body d-flex flex-column">
              <!-- 1. Configuración de fecha de entrega (OBLIGATORIO) -->
              <div class="row mb-4">
                <div class="col-12">
                  <div class="card ">
                    <div class="card-body p-3">
                      <div class="row align-items-center g-3">
                        <div class="col-12 col-md-6">
                          <h6 class="fw-bold text-warning-emphasis mb-3">
                            <i class="bi bi-calendar-event me-2"></i>Fecha de entrega (Obligatorio)
                          </h6>
                        </div>

                        <!-- Select de Locación (GLACIAR, HERMES) -->
                        <div class="col-12 col-md-3">
                          <label class="form-label mb-1 fw-bold"><span class="text-danger">*</span> Locación:</label>
                          <select 
                            class="form-select" 
                            [(ngModel)]="businessUnit"
                            (change)="onLocationChange()"
                            [disabled]="isLoadingFormData || locations.length === 0 || isLocationLocked">
                            <option value="">{{ isLoadingFormData ? 'Cargando...' : 'Seleccionar locación' }}</option>
                            <option *ngFor="let location of locations; trackBy: trackByLocationId" [value]="location.name">
                              {{ location.name }}
                            </option>
                          </select>
                        </div>
                        
                        <!-- Select de Tipo de solicitud (Devolución) -->
                        <div class="col-12 col-md-3">
                          <label class="form-label mb-1 fw-bold"><span class="text-danger">*</span> Tipo de solicitud:</label>
                          <select 
                            class="form-select" 
                            [(ngModel)]="isDevolucion"
                            [disabled]="isLoadingFormData || !businessUnit">
                            <option [value]="false">Requisición normal</option>
                            <option [value]="true">Devolución de productos</option>
                          </select>
                        </div>
                        
                        <!-- Select de Evento especial (solo visible con permiso 'events') -->
                        <div class="col-12 col-md-3" *hasPermission="{submodule: 'requisition', permission: 'events'}">
                          <label class="form-label mb-1 fw-bold">Evento especial:</label>
                          <select 
                            class="form-select" 
                            [(ngModel)]="selectedEvent"
                            (change)="onEventChange()"
                            [disabled]="isLoadingFormData || projects.length === 0 || !businessUnit">
                            <option value="">{{ isLoadingFormData ? 'Cargando...' : 'Seleccionar evento' }}</option>
                            <option 
                              *ngFor="let project of projects; trackBy: trackByProjectId" 
                              [value]="project.id"
                              [disabled]="isEventDatePassed(project.date)">
                              {{ project.name }} ({{ formatDate(project.date) }})  </option>
                          </select>
                          <small class="text-muted">*Entrega el mismo día del evento</small>
                        </div>
                        
                        <div class="col-12 col-md-3">
                          <label class="form-label mb-1 fw-bold"><span class="text-danger">*</span> Fecha de entrega:</label>
                          <input 
                            type="date" 
                            class="form-control"
                            [(ngModel)]="customDeliveryDate"
                            (change)="onCustomDateChange()"
                            [min]="getMinDate()"
                            [disabled]="!businessUnit">
                          <small class="text-muted">Fecha exacta de entrega</small>
                        </div>
                        
                        <div class="col-12 col-md-2">
                          <label class="form-label mb-1 fw-bold"><span class="text-danger">*</span> Hora:</label>
                          <input 
                            type="time" 
                            class="form-control"
                            [(ngModel)]="deliveryTime"
                            (change)="onTimeChange()"
                            [disabled]="!businessUnit || (!selectedEvent && !customDeliveryDate)">
                          <small class="text-muted">*Para ambas opciones</small>
                        </div>
                        
                        <div class="col-12 col-md-3 d-flex flex-column" *ngIf="currentDeliveryDate">
                          <label class="form-label mb-1 fw-bold">Programado:</label>
                          <div class="border rounded p-2 bg-light">
                            <div class="text-center">
                              <div><span class="fw-bold text-dark me-3">{{ formatDate(currentDeliveryDate) }}</span><span class="fw-bold text-primary">{{ formatTime(currentDeliveryDate) }}</span></div>
                            </div>
                          </div>
                          <small class="text-muted">&nbsp;</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 2. Selección de área (SEGUNDO) -->
              <div class="row align-items-center mb-4">
                <div class="col-12 col-lg-auto">
                  <label class="form-label fw-bold mb-2"><span class="text-danger">*</span> Área:</label>
                </div>
                <div class="col-12 col-lg-5 position-relative">
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="areaSearchTerm"
                    (input)="onAreaSearch()"
                    (focus)="onAreaFocus()"
                    (blur)="onAreaBlur()"
                    (keydown)="onAreaKeydown($event)"
                    [disabled]="!businessUnit || !currentDeliveryDate"
                    placeholder="Buscar área..."
                    autocomplete="off">
                  
                  <!-- Dropdown de áreas -->
                  <div 
                    class="dropdown-menu show w-100 area-dropdown" 
                    *ngIf="showAreaDropdown && filteredAreas.length > 0"
                    style="position: absolute; top: 100%; z-index: 1000; max-height: 200px; overflow-y: auto;">
                    <button 
                      type="button"
                      class="dropdown-item d-flex justify-content-between"
                      *ngFor="let area of filteredAreas; let i = index; trackBy: trackByString"
                      [class.active]="i === selectedAreaIndex"
                      (mousedown)="selectArea(area)"
                      (mouseenter)="selectedAreaIndex = i">
                      <span>{{ area }}</span>
                      <span *ngIf="hasProductsInArea(area)" class="text-success">✓</span>
                    </button>
                  </div>
                  
                  <!-- Mensaje cuando no hay resultados -->
                  <div 
                    class="dropdown-menu show w-100" 
                    *ngIf="showAreaDropdown && filteredAreas.length === 0 && areaSearchTerm.length > 0"
                    style="position: absolute; top: 100%; z-index: 1000;">
                    <div class="dropdown-item-text text-muted">
                      No se encontraron áreas
                    </div>
                  </div>
                </div>
              </div>

              <!-- 3. Búsqueda de productos (TERCERO) -->
              <div class="row mb-4">
                <div class="col-md-5 position-relative">
                  <label class="form-label "><span class="text-danger">*</span> Producto</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="productSearchTerm"
                    (input)="onProductSearch()"
                    (focus)="onProductFocus()"
                    (blur)="onProductBlur()"
                    (keydown)="onProductKeydown($event)"
                    [disabled]="!businessUnit || !currentDeliveryDate || !selectedArea"
                    placeholder="Buscar producto..."
                    autocomplete="off"
                  >
                  
                  <!-- Dropdown de productos -->
                  <div 
                    class="dropdown-menu show w-100 product-dropdown" 
                    *ngIf="showProductDropdown && filteredProducts.length > 0 && !(!currentDeliveryDate || !selectedArea)"
                    style="position: absolute; top: 100%; z-index: 1000; max-height: 200px; overflow-y: auto;">
                    <button 
                      type="button"
                      class="dropdown-item"
                      *ngFor="let product of filteredProducts; let i = index; trackBy: trackByString"
                      [class.active]="i === selectedProductIndex"
                      (mousedown)="selectProduct(product)"
                      (mouseenter)="selectedProductIndex = i">
                      {{ product }}
                    </button>
                  </div>
                  
                  <!-- Mensaje cuando no hay resultados -->
                  <div 
                    class="dropdown-menu show w-100" 
                    *ngIf="showProductDropdown && filteredProducts.length === 0 && productSearchTerm.length > 0 && !(!currentDeliveryDate || !selectedArea)"
                    style="position: absolute; top: 100%; z-index: 1000;">
                    <div class="dropdown-item-text text-muted">
                      No se encontraron productos
                    </div>
                  </div>
                </div>
                <div class="col-md-2">
                  <label class="form-label "><span class="text-danger">*</span> Cantidad</label>
                  <input 
                    type="text" 
                    class="form-control " 
                    [(ngModel)]="currentQuantity"
                    (input)="validateNumberInput($event)"
                    placeholder="Ingrese cantidad"
                    [disabled]="!businessUnit || !currentDeliveryDate || !selectedArea">
                </div>
                <div class="col-md-3">
                  <label class="form-label ">Presentación</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    [value]="selectedProductData?.unit || ''"
                    [placeholder]="selectedProductData ? selectedProductData.unit : 'Selecciona producto'"
                    readonly
                    disabled>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button class="btn btn-primary w-100" (click)="onAddProduct()" 
                          [disabled]="!businessUnit || !currentDeliveryDate || !selectedArea || !productSearchTerm.trim() || !isValidQuantity()">
                    Agregar
                  </button>
                </div>
              </div>
              
              <!-- Lista de productos seleccionados -->
              <div class="overflow-auto flex-grow-1" style="max-height: 250px;">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-primary">
                      <tr>
                        <th class="py-3">Producto</th>
                        <th class="py-3">Cantidad</th>
                        <th class="py-3">Presentación</th>
                        <th class="py-3">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let product of products; trackBy: trackByProductId">
                        <td class="fs-6 py-3">{{ product.name }}</td>
                        <td>
                          <div class="input-group" style="width: 150px;">
                            <button 
                              class="btn btn-outline-secondary" 
                              type="button" 
                              (click)="decrementQuantity(product.id)"
                              [disabled]="product.quantity <= 1">
                              <i class="bi bi-dash"></i>
                            </button>
                            <input 
                              type="text" 
                              class="form-control text-center" 
                              [value]="product.quantity"
                              (input)="updateQuantityFromInput(product.id, $event)"
                              (blur)="validateTableInput(product.id, $event)">
                            <button 
                              class="btn btn-outline-secondary" 
                              type="button" 
                              (click)="incrementQuantity(product.id)">
                              <i class="bi bi-plus"></i>
                            </button>
                          </div>
                        </td>
                        <td class="fs-6 py-3">{{ product.unit }}</td>
                        <td>
                          <button 
                            class="btn btn-danger"
                            (click)="removeProduct(product.id)">
                            <i class="bi bi-trash"></i>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div class="text-end mt-auto pt-4">
                <button class="btn btn-primary px-5" (click)="onAccept()">
                  Aceptar
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Panel derecho - Resumen de solicitud -->
        <div [class]="isResumeCollapsed ? 'col-1' : 'col-lg-5'" class="transition-all">
          <div class="card shadow h-100">
        <div class="card-header bg-success text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1" [class.d-none]="isResumeCollapsed">
              <h4 class="text-white mb-0">Resumen de solicitud</h4>
            </div>
            <!-- Spacer invisible para mantener el botón a la derecha cuando está colapsado -->
            <div class="flex-grow-1" [class.d-none]="!isResumeCollapsed"></div>
            <button 
              class="btn btn-success btn-sm border-white" 
              (click)="toggleResumePanel()"
              [title]="isResumeCollapsed ? 'Mostrar resumen' : 'Ocultar resumen'">
              <i [class]="isResumeCollapsed ? 'bi bi-chevron-left' : 'bi bi-chevron-right'"></i>
            </button>
          </div>
        </div>
        
        <div class="card-body p-4 d-flex flex-column" [class.d-none]="isResumeCollapsed">
          <!-- Información de fecha de entrega movida aquí -->
          <div class="mb-4">
            <div *ngIf="getRequestDeliveryDate()" class="mb-0">
              <i class="bi bi-calendar-check me-2"></i>
              <strong>Fecha de entrega:</strong> {{ formatDate(getRequestDeliveryDate()!) }} {{ formatTime(getRequestDeliveryDate()!) }}
            </div>
            <div *ngIf="!getRequestDeliveryDate()" class="mb-0">
              <i class="bi bi-calendar-x me-2"></i>
              <strong>Sin fecha programada</strong> - Selecciona una fecha de entrega
            </div>
          </div>
          
          <!-- Contenedor con scroll para las áreas -->
          <div class="overflow-auto flex-grow-1" style="max-height: 40vh;">
            <div *ngIf="requisitionSummary.length === 0" class="text-center text-muted py-5">
              <i class="bi bi-clipboard-x fs-1 d-block mb-3"></i>
              <p class="fs-5">No hay áreas con productos agregados</p>
              <small>Selecciona un área, agrega productos y presiona "Aceptar"</small>
            </div>
            
            <div *ngFor="let summary of requisitionSummary; trackBy: trackByAreaName" class="mb-4">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1">
                  <h5 class="text-primary fw-bold mb-1">{{ summary.area }}</h5>
                </div>
                
                <!-- Grupo de botones -->
                <div class="btn-group btn-group-sm" role="group">
                  <!-- Botón Editar -->
                  <button 
                    class="btn btn-outline-primary"
                    (click)="editAreaFromSummary(summary.area)"
                    title="Editar área">
                    <i class="bi bi-pencil"></i>
                  </button>
                  
                  <!-- Botón Eliminar -->
                  <button 
                    class="btn btn-outline-danger"
                    (click)="removeAreaFromSummary(summary.area)"
                    title="Eliminar área">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-borderless">
                  <thead class="table-secondary">
                    <tr>
                      <th class="fs-6 py-3">Producto</th>
                      <th class="fs-6 py-3">Cantidad</th>
                      <th class="fs-6 py-3">Presentación</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let product of summary.products; trackBy: trackByProductName">
                      <td class="fs-6 py-2">{{ product.name }}</td>
                      <td class="fs-6 py-2">{{ product.quantity }}</td>
                      <td class="fs-6 py-2">{{ product.unit }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <div class="text-end mt-auto pt-4" *ngIf="requisitionSummary.length > 0">
            <button 
              class="btn btn-success px-5" 
              (click)="onConfirmRequisition()"
              [disabled]="!currentDeliveryDate"
              [class.btn-secondary]="!currentDeliveryDate"
              [class.btn-success]="currentDeliveryDate">
              {{ currentDeliveryDate ? 'Confirmar solicitud' : 'Selecciona una fecha de entrega' }}
            </button>
          </div>
        </div>
        
        <!-- Vista colapsada - Solo mostrar áreas -->
        <div class="card-body p-2" [class.d-none]="!isResumeCollapsed">
          <!-- Información de fecha en vista colapsada -->
          <div class="mb-3 p-2 rounded" 
               [class]="getRequestDeliveryDate() ? 'bg-success text-white' : 'bg-warning text-dark'">
            <div *ngIf="getRequestDeliveryDate()" class="text-center">
              <i class="bi bi-calendar-check me-1"></i>
              <small class="fw-bold">{{ formatDate(getRequestDeliveryDate()!) }} {{ formatTime(getRequestDeliveryDate()!) }}</small>
            </div>
            <div *ngIf="!getRequestDeliveryDate()" class="text-center">
              <i class="bi bi-calendar-x me-1"></i>
              <small class="fw-bold">Sin fecha</small>
            </div>
          </div>
          
          <div *ngIf="requisitionSummary.length === 0" class="text-center text-muted py-2">
            <i class="bi bi-clipboard-x fs-4 d-block mb-1"></i>
            <small>Sin áreas</small>
          </div>
          
          <div *ngFor="let summary of requisitionSummary; trackBy: trackByAreaName" class="mb-2">
            <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
              <div class="flex-grow-1">
                <small class="text-primary fw-bold">{{ summary.area }}</small>
                <br>
                <small class="text-muted">{{ summary.products.length }} producto(s)</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación para cambio de área -->
<div class="modal" *ngIf="showAreaChangeModal" 
     style="display: block; z-index: 9999; background-color: rgba(0, 0, 0, 0.3);" 
     (click)="closeAreaChangeModal()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header bg-warning text-dark border-0">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Cambio de área
        </h5>
        <button type="button" class="btn-close" (click)="closeAreaChangeModal()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <p class="fw-bold">Tienes productos sin agregar a la requisición en el área: <span class="text-primary">{{ currentAreaWithProducts }}</span></p>
          <p>¿Qué deseas hacer con estos productos?</p>
        </div>
        
        <!-- Resumen de productos actuales -->
        <div class="card bg-light border-0 shadow-sm" *ngIf="products.length > 0">
          <div class="card-header py-2 bg-primary text-white border-0">
            <h6 class="mb-0">Productos que se agregarán al área "{{ currentAreaWithProducts }}":</h6>
          </div>
          <div class="card-body py-2">
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Presentación</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let product of products; trackBy: trackByProductId">
                    <td>{{ product.name }}</td>
                    <td>{{ product.quantity }}</td>
                    <td>{{ product.unit }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" (click)="cancelAreaChange()">
          <i class="bi bi-x-circle me-2"></i>
          Cancelar y descartar
        </button>
        <button type="button" class="btn btn-success" (click)="addToRequisitionAndChange()">
          <i class="bi bi-plus-circle me-2"></i>
          Agregar a requisición
        </button>
      </div>
    </div>
  </div>
</div>