import { Component, OnInit, AfterViewInit, ViewChild, ElementRef, Input, Output, EventEmitter, OnDestroy, OnChanges, SimpleChanges, NgZone } from '@angular/core';
import { CommonModule } from '@angular/common';
import Swal from 'sweetalert2';

declare var $: any; // Para jQuery/DataTables

export interface User {
  id: string;
  username: string;
  email: string;
  firstName: string;
  lastName: string;
  employeeNumber: string;
  role: string;
  isActive: boolean;
  createdAt: Date;
  lastLogin?: Date;
}

@Component({
  selector: 'app-users-list',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './users-list.html',
  styleUrls: ['./users-list.scss']
})
export class UsersListComponent implements OnInit, AfterViewInit, OnChanges, OnDestroy {
  @ViewChild('usersTable', { static: false }) usersTable!: ElementRef;
  
  private _users: User[] = [];
  @Input() 
  set users(value: User[]) {
    console.log('ðŸ“¥ Setter users llamado con', value?.length || 0, 'usuarios');
    this._users = value;
    
    // Solo actualizar si la vista ya estÃ¡ lista
    if (this.viewInitialized) {
      this.updateDataTable();
    }
  }
  get users(): User[] {
    return this._users;
  }
  
  @Output() editUser = new EventEmitter<User>();
  @Output() viewUser = new EventEmitter<User>();
  @Output() syncUsers = new EventEmitter<void>();
  @Output() deleteUser = new EventEmitter<string>();
  @Output() toggleUserStatus = new EventEmitter<string>();

  // DataTables
  private usersDataTable: any;
  private viewInitialized = false;
  private initTimeout: any = null;  // Guardar referencia al timeout
  private isInitializing = false;  // Flag para evitar inicializaciones concurrentes

  constructor(private ngZone: NgZone) {}

  ngOnInit(): void {
    console.log('âœ… UsersListComponent initialized, usuarios:', this.users.length);
  }

  ngOnChanges(changes: SimpleChanges): void {
    console.log('ðŸ”” ngOnChanges detectado:', changes);
    console.log('ðŸ” viewInitialized:', this.viewInitialized);
    // NO hacer nada aquÃ­, dejar que el setter maneje los cambios
  }

  ngAfterViewInit(): void {
    console.log('ðŸ”„ ngAfterViewInit, usuarios:', this.users.length);
    this.viewInitialized = true;
    
    // Inicializar DataTable una vez que la vista estÃ© lista
    this.initTimeout = setTimeout(() => {
      this.updateDataTable();
    }, 150);
  }

  ngOnDestroy(): void {
    // Cancelar timeout pendiente si existe
    if (this.initTimeout) {
      clearTimeout(this.initTimeout);
    }
    
    if (this.usersDataTable) {
      // Limpiar event listeners antes de destruir
      $(this.usersTable.nativeElement).off('click', '.view-btn');
      $(this.usersTable.nativeElement).off('click', '.edit-btn');
      $(this.usersTable.nativeElement).off('click', '.delete-btn');
      
      this.usersDataTable.destroy(true); // true = remove from DOM completely
      console.log('ðŸ§¹ DataTable destruido y event listeners limpiados');
    }
  }

  private updateDataTable(): void {
    console.log('ðŸ”„ updateDataTable llamado, usuarios:', this.users.length);
    
    // Cancelar cualquier inicializaciÃ³n pendiente
    if (this.initTimeout) {
      console.log('â° Cancelando timeout pendiente');
      clearTimeout(this.initTimeout);
      this.initTimeout = null;
    }
    
    // Verificar si la tabla YA es un DataTable usando la API de DataTables
    if ($.fn.DataTable.isDataTable(this.usersTable.nativeElement)) {
      console.log('ðŸ§¹ Tabla ya es DataTable, destruyendo...');
      $(this.usersTable.nativeElement).off('click', '.view-btn');
      $(this.usersTable.nativeElement).off('click', '.edit-btn');
      $(this.usersTable.nativeElement).off('click', '.delete-btn');
      $(this.usersTable.nativeElement).DataTable().destroy(true);
      this.usersDataTable = null;
    }
    
    // Solo inicializar si hay usuarios
    if (this.users.length > 0) {
      console.log('ðŸš€ Inicializando DataTable con', this.users.length, 'usuarios');
      this.initUsersDataTable();
    }
  }

  private initUsersDataTable(): void {
    if (!this.usersTable || this.users.length === 0) {
      return;
    }
    
    // PROTECCIÃ“N 1: Evitar inicializaciones concurrentes
    if (this.isInitializing) {
      console.log('âš ï¸ Ya hay una inicializaciÃ³n en progreso, abortando');
      return;
    }
    
    // PROTECCIÃ“N 2: Si la tabla ya es DataTable, NO inicializar
    if ($.fn.DataTable.isDataTable(this.usersTable.nativeElement)) {
      console.log('âš ï¸ ADVERTENCIA: La tabla ya es DataTable, abortando inicializaciÃ³n');
      return;
    }
    
    this.isInitializing = true;
    console.log('ðŸŽ¯ Creando DataTable con', this.users.length, 'usuarios');
    
    try {
      // Convertir usuarios a formato de datos para DataTables
      const tableData = this.users.map(user => {
        return [
          `<div class="d-flex align-items-center">
            <div>
              <strong>${user.username}</strong>
              <br>
              <small class="text-muted">${this.getFullName(user)}</small>
              <br>
              <small class="text-muted">No. Empleado: ${user.employeeNumber}</small>
            </div>
          </div>`,
          `<span class="badge bg-info">${user.role}</span>`,
          `<span class="badge ${user.isActive ? 'bg-success' : 'bg-secondary'}">
            ${user.isActive ? 'Activo' : 'Inactivo'}
          </span>`,
          `<button class="btn btn-sm btn-light me-1 view-btn" data-id="${user.id}" title="Ver detalles del usuario" style="border: 1px solid #dee2e6;">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-sm btn-light me-1 edit-btn" data-id="${user.id}" title="Editar usuario" style="border: 1px solid #dee2e6;">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-light delete-btn" data-id="${user.id}" title="Eliminar usuario" style="border: 1px solid #dee2e6;">
            <i class="bi bi-trash"></i>
          </button>`
        ];
      });

      this.usersDataTable = $(this.usersTable.nativeElement).DataTable({
        data: tableData,
        columns: [
          { title: 'Usuario' },
          { title: 'Rol' },
          { title: 'Estado', className: 'text-center' },
          { title: 'Acciones', className: 'text-center', orderable: false }
        ],
        language: {
          "decimal": "",
          "emptyTable": "No hay datos disponibles en la tabla",
          "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
          "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
          "infoFiltered": "(filtrado de _MAX_ entradas totales)",
          "infoPostFix": "",
          "thousands": ",",
          "lengthMenu": "Mostrar _MENU_ entradas",
          "loadingRecords": "Cargando...",
          "processing": "Procesando...",
          "search": "Buscar:",
          "zeroRecords": "No se encontraron registros coincidentes",
          "paginate": {
            "first": "Primero",
            "last": "Ãšltimo",
            "next": "Siguiente",
            "previous": "Anterior"
          },
          "aria": {
            "sortAscending": ": activar para ordenar la columna ascendente",
            "sortDescending": ": activar para ordenar la columna descendente"
          }
        },
        responsive: true,
        pageLength: 10,
        order: [[0, 'asc']]
      });

      // Event listeners para botones
      $(this.usersTable.nativeElement).on('click', '.view-btn', (e: any) => {
        const userId = $(e.currentTarget).data('id');
        const user = this.users.find(u => u.id === userId);
        if (user) {
          this.ngZone.run(() => {
            this.onViewUser(user);
          });
        }
      });

      $(this.usersTable.nativeElement).on('click', '.edit-btn', (e: any) => {
        const userId = $(e.currentTarget).data('id');
        const user = this.users.find(u => u.id === userId);
        if (user) {
          this.ngZone.run(() => {
            this.onEditUser(user);
          });
        }
      });

      $(this.usersTable.nativeElement).on('click', '.delete-btn', (e: any) => {
        const userId = $(e.currentTarget).data('id');
        this.ngZone.run(() => {
          this.onDeleteUser(userId);
        });
      });

      console.log('âœ… DataTable inicializado correctamente con', this.users.length, 'usuarios');
      console.log('âœ… Event listeners configurados para botones');
    } finally {
      this.isInitializing = false;
    }
  }

  refreshDataTables(): void {
    // Verificar si la tabla YA es un DataTable usando la API de DataTables
    if ($.fn.DataTable.isDataTable(this.usersTable.nativeElement)) {
      $(this.usersTable.nativeElement).off('click', '.view-btn');
      $(this.usersTable.nativeElement).off('click', '.edit-btn');
      $(this.usersTable.nativeElement).off('click', '.delete-btn');
      $(this.usersTable.nativeElement).DataTable().destroy(true);
    }
    
    setTimeout(() => {
      this.initUsersDataTable();
    }, 100);
  }

  onSyncUsers(): void {
    this.syncUsers.emit();
  }

  onViewUser(user: User): void {
    this.viewUser.emit(user);
  }

  onEditUser(user: User): void {
    this.editUser.emit(user);
  }

  onDeleteUser(userId: string): void {
    const user = this.users.find(u => u.id === userId);
    if (!user) return;

    Swal.fire({
      title: 'Â¿Eliminar usuario?',
      html: `Â¿EstÃ¡s seguro de que deseas eliminar al usuario <strong>${user.username}</strong>?<br><small class="text-muted">Esta acciÃ³n no se puede deshacer</small>`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'SÃ­, eliminar',
      cancelButtonText: 'Cancelar',
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d'
    }).then((result) => {
      if (result.isConfirmed) {
        this.deleteUser.emit(userId);
        
        Swal.fire({
          icon: 'success',
          title: 'Usuario eliminado',
          text: `El usuario "${user.username}" ha sido eliminado exitosamente`,
          confirmButtonText: 'Continuar',
          timer: 2000,
          timerProgressBar: true
        });
      }
    });
  }

  onToggleUserStatus(userId: string): void {
    const user = this.users.find(u => u.id === userId);
    if (user) {
      this.toggleUserStatus.emit(userId);
      
      Swal.fire({
        icon: 'success',
        title: 'Estado actualizado',
        text: `El usuario "${user.username}" ahora estÃ¡ ${!user.isActive ? 'activo' : 'inactivo'}`,
        confirmButtonText: 'Continuar',
        timer: 1500,
        timerProgressBar: true
      });
    }
  }

  getFullName(user: User): string {
    return `${user.firstName} ${user.lastName}`;
  }

  formatDate(date: Date | undefined): string {
    if (!date) return 'Nunca';
    const d = new Date(date);
    return d.toLocaleDateString('es-ES', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
}
