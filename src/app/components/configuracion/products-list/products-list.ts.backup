import { Component, OnInit, AfterViewInit, ViewChild, ElementRef, Input, Output, EventEmitter, OnDestroy, OnChanges, SimpleChanges } from '@angular/core';
import { CommonModule } from '@angular/common';
import Swal from 'sweetalert2';

declare var $: any; // Para jQuery/DataTables

export interface Product {
  id: string;
  code: string;
  name: string;
  description: string;
  category_id: number;
  category_name: string;
  category_is_inactive: boolean;
  subcategory_id: number;
  subcategory_name: string;
  subcategory_is_inactive: boolean;
  unit: string;
  isActive: boolean;
  createdAt: Date;
  lastSync?: Date;
}

@Component({
  selector: 'app-products-list',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './products-list.html',
  styleUrls: ['./products-list.scss']
})
export class ProductsListComponent implements OnInit, AfterViewInit, OnDestroy, OnChanges {
  @ViewChild('productsTable', { static: false }) productsTable!: ElementRef;
  
  private _products: Product[] = [];
  @Input() 
  set products(value: Product[]) {
    console.log('ðŸ“¥ [SETTER] products recibido:', value?.length || 0, 'productos');
    this._products = value;
    
    // Si ya se inicializÃ³ la vista, refrescar
    if (this.viewInitialized && value && value.length > 0) {
      console.log('ðŸ”„ [SETTER] Vista inicializada, refrescando DataTable');
      setTimeout(() => {
        this.refreshDataTables();
      }, 100);
    }
  }
  get products(): Product[] {
    return this._products;
  }
  
  @Output() viewProduct = new EventEmitter<Product>();
  @Output() syncProducts = new EventEmitter<void>();

  // DataTables
  private productsDataTable: any;
  private viewInitialized = false;

  constructor() {}

  ngOnInit(): void {
    console.log('âœ… ProductsListComponent initialized, productos:', this.products.length);
  }

  ngAfterViewInit(): void {
    console.log('ðŸ”„ [ngAfterViewInit] Vista inicializada, productos:', this.products.length);
    this.viewInitialized = true;
    
    // Inicializar DataTables despuÃ©s de que la vista estÃ© lista
    setTimeout(() => {
      this.initProductsDataTable();
    }, 100);
  }

  ngOnChanges(changes: SimpleChanges): void {
    console.log('ðŸ”” [ngOnChanges] Detectado cambio:', changes);
    
    // Cuando cambia el input de products, refrescar la tabla
    if (changes['products']) {
      const current = changes['products'].currentValue;
      const previous = changes['products'].previousValue;
      
      console.log('ï¿½ [ngOnChanges] Productos - anterior:', previous?.length || 0, 'actual:', current?.length || 0);
      
      // Si no es el primer cambio Y hay productos
      if (!changes['products'].firstChange && current && current.length > 0) {
        console.log('ðŸ”„ [ngOnChanges] Refrescando DataTable con', current.length, 'productos');
        this.refreshDataTables();
      }
    }
  }

  ngOnDestroy(): void {
    if (this.productsDataTable) {
      this.productsDataTable.destroy();
    }
  }

  private initProductsDataTable(): void {
    if (this.productsTable && this.products.length > 0) {
      this.productsDataTable = $(this.productsTable.nativeElement).DataTable({
        language: {
          "decimal": "",
          "emptyTable": "No hay datos disponibles en la tabla",
          "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
          "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
          "infoFiltered": "(filtrado de _MAX_ entradas totales)",
          "infoPostFix": "",
          "thousands": ",",
          "lengthMenu": "Mostrar _MENU_ entradas",
          "loadingRecords": "Cargando...",
          "processing": "Procesando...",
          "search": "Buscar:",
          "zeroRecords": "No se encontraron registros coincidentes",
          "paginate": {
            "first": "Primero",
            "last": "Ãšltimo",
            "next": "Siguiente",
            "previous": "Anterior"
          },
          "aria": {
            "sortAscending": ": activar para ordenar la columna ascendente",
            "sortDescending": ": activar para ordenar la columna descendente"
          }
        },
        responsive: true,
        pageLength: 10,
        order: [[0, 'asc']],
        columnDefs: [
          { orderable: false, targets: [3] }, // Deshabilitar orden en acciones
          { className: 'text-center', targets: [2, 3] } // Centrar Estado y Acciones
        ]
      });
    }
  }

  refreshDataTables(): void {
    if (this.productsDataTable) {
      this.productsDataTable.destroy();
    }
    
    setTimeout(() => {
      this.initProductsDataTable();
    }, 100);
  }

  onSyncProducts(): void {
    this.syncProducts.emit();
  }

  onViewProduct(product: Product): void {
    this.viewProduct.emit(product);
  }

  formatDate(date: Date | undefined): string {
    if (!date) return 'Nunca';
    const d = new Date(date);
    return d.toLocaleDateString('es-ES', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
}
